{% extends "base.html" %}
{# Extends base layout for consistent site-wide structure #}

{% block title %}MUS-HUB | Home{% endblock %}
{# Page title #}

{% block extra_css %}
  {# Include CSS specific for home page styling #}
  <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
  {# Google Fonts import for consistent typography #}
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
  {# NOTE: There is a stray '<' here that should be removed #}
{% endblock %}

{% block content %}

<!-- Background image overlay for visual effect -->
<div class="image-overlay"></div>

<div class="container">
  {% if 'user_id' in session %}
    {# Show welcome message and profile link if user is logged in #}
    <h2>Welcome, {{ username }}!</h2>
    <a href="{{ url_for('profile') }}" class="profile-link" aria-label="Go to your profile">
      {# SVG icon for profile #}
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
      </svg>
      Go to Profile
    </a>

    {# Display any flash messages (notifications, errors, etc.) #}
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class="flashes" role="alert">
          {% for message in messages %}
            <li>{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <h2>Latest Uploads</h2>
    {% for content in contents %}
      <div class="upload" role="region" aria-labelledby="upload-title-{{ content.ContentID }}">
        {# Show uploader info with link to public profile #}
        <p><strong>By:</strong> 
          <a href="{{ url_for('public_profile', user_id=content.user.UserID) }}">
            {{ content.user.Username }}
          </a>
        </p>
        <p><strong>Uploaded:</strong> {{ content.UploadDate.strftime('%Y-%m-%d %H:%M:%S') }}</p>
        <p><strong>File:</strong> {{ content.FilePath }}</p>

        {# Determine file extension to display appropriate media player #}
        {% set ext = content.FilePath.split('.')[-1].lower() %}
        {% if ext in ['mp3', 'wav', 'ogg'] %}
          {# Audio player for audio files #}
          <audio controls>
            <source src="{{ url_for('static', filename='uploads/' ~ content.FilePath) }}" type="audio/{{ ext }}">
            Your browser does not support audio playback.
          </audio>
        {% elif ext in ['mp4', 'webm'] %}
          {# Video player for video files #}
          <video controls width="360" aria-labelledby="upload-title-{{ content.ContentID }}">
            <source src="{{ url_for('static', filename='uploads/' ~ content.FilePath) }}" type="video/{{ ext }}">
            Your browser does not support video playback.
          </video>
        {% else %}
          {# Message when preview is not available #}
          <p>Preview not available for this file type.</p>
        {% endif %}

        {# Button to toggle comments section with ARIA attributes for accessibility #}
        <button 
          aria-expanded="false" 
          aria-controls="comments-{{ content.ContentID }}" 
          onclick="toggleComments('comments-{{ content.ContentID }}', this)" 
          class="comments-toggle"
          >
          {# Comment icon SVG #}
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v14l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
          </svg>
          Comments
        </button>

        {# Hidden comments section, initially not displayed #}
        <div id="comments-{{ content.ContentID }}" class="comment-section" style="display: none;">
          <h4 id="upload-title-{{ content.ContentID }}">Comments:</h4>
          <ul>
            {% for comment in content.comments %}
              <li>
                <strong>
                  <a href="{{ url_for('public_profile', user_id=comment.user.UserID) }}">
                    {{ comment.user.Username }}
                  </a>
                </strong>:
                {# Allow comment editing only within 30 seconds and by comment author #}
                {% if (current_user_id == comment.UserID) and ((now - comment.CommentDate).total_seconds() < 30) %}
                  <form action="{{ url_for('edit_comment', comment_id=comment.CommentID) }}" method="POST" style="display:inline;">
                    <input type="text" name="comment_text" value="{{ comment.CommentText }}" aria-label="Edit comment">
                    <button type="submit">Update</button>
                  </form>
                {% else %}
                  {{ comment.CommentText }}
                {% endif %}
                <small>({{ comment.CommentDate.strftime('%Y-%m-%d %H:%M:%S') }})</small>
              </li>
            {% endfor %}
          </ul>

          {# Form to add a new comment to this content #}
          <form action="{{ url_for('add_comment', content_id=content.ContentID) }}" method="POST">
            <textarea name="comment_text" placeholder="Leave a comment..." required aria-label="Leave a comment"></textarea>
            <button type="submit" class="submit-comment-btn">
              {# Submit icon SVG #}
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
              </svg>
              Submit Comment
            </button>
          </form>
        </div>
      </div>
    {% endfor %}

    {# JavaScript functions to toggle comment sections and animate icons #}
    <script>
      function toggleComments(id, btn) {
        const section = document.getElementById(id);
        const isHidden = section.style.display === "none";
        section.style.display = isHidden ? "block" : "none";
        btn.setAttribute("aria-expanded", isHidden ? "true" : "false");

        // Animate icon on click
        const icon = btn.querySelector('.icon');
        if(icon) {
          icon.classList.remove('animate');
          void icon.offsetWidth;  // trigger reflow to restart animation
          icon.classList.add('animate');
        }
      }

      // Animate submit comment button icon on click
      document.querySelectorAll('.submit-comment-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const icon = btn.querySelector('.icon');
          if(icon) {
            icon.classList.remove('animate');
            void icon.offsetWidth;
            icon.classList.add('animate');
          }
        });
      });

      // Animate profile link icon on hover/focus for better UX
      const profileLink = document.querySelector('.profile-link');
      if(profileLink) {
        const icon = profileLink.querySelector('.icon');
        profileLink.addEventListener('mouseenter', () => icon?.classList.add('animate'));
        profileLink.addEventListener('mouseleave', () => icon?.classList.remove('animate'));
        profileLink.addEventListener('focus', () => icon?.classList.add('animate'));
        profileLink.addEventListener('blur', () => icon?.classList.remove('animate'));
      }
    </script>

  {% else %}
    {# Show this section if user is not logged in #}
    <section class="web-summary" role="region" aria-label="About MUS-HUB">
      <p>
        ðŸŽ¶ <strong>MUS-HUB</strong> is the ultimate space where <strong>musicians and listeners unite</strong>. 
        Share your sounds, connect with talent, and vibe with the rhythm of a creative community. 
        Whether youâ€™re an artist or a fan, <em>this is your stage</em>.
      </p>
    </section>
  {% endif %}
</div>

{% endblock %}
